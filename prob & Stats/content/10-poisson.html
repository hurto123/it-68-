<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>บทที่ 10: การแจกแจงปัวซง</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    :root { color-scheme: light dark; }
    body.page {
      min-height: 100vh;
      background: linear-gradient(150deg, rgba(236,239,241,0.92), rgba(207,216,220,0.92));
      font-family: "IBM Plex Sans Thai", "Prompt", "Sarabun", system-ui, sans-serif;
    }
    main.container { max-width: 1120px; margin: 0 auto; padding: clamp(2rem,5vw,3.5rem); }
    header.hero {
      background: linear-gradient(135deg, #37474f, #607d8b);
      color: #fff;
      padding: clamp(2.8rem,6vw,4rem);
      border-radius: 32px;
      position: relative;
      overflow: hidden;
      margin-bottom: 2.4rem;
      box-shadow: 0 30px 50px rgba(55,71,79,0.28);
    }
    header.hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 80% 20%, rgba(255,255,255,0.32), transparent 60%),
                  radial-gradient(circle at 18% 70%, rgba(255,255,255,0.18), transparent 70%);
    }
    header.hero h1 { font-size: clamp(2.4rem,3vw+1.5rem,3.6rem); margin-bottom: 0.75rem; }
    header.hero p { font-size: 1.12rem; max-width: 760px; line-height: 1.7; }
    section.card {
      background: rgba(255,255,255,0.95);
      border-radius: 26px;
      padding: clamp(1.7rem,4vw,2.7rem);
      margin-bottom: 2.2rem;
      box-shadow: 0 22px 38px rgba(55,71,79,0.18);
    }
    h2 {
      display:flex;
      align-items:center;
      gap:0.75rem;
      color:#37474f;
      font-size:1.95rem;
    }
    .badge { background: rgba(176,190,197,0.8); color:#263238; border-radius:999px; padding:0.18rem 0.9rem; font-weight:600; }
    .grid { display:grid; gap:1.4rem; }
    @media (min-width:950px) { .grid.two { grid-template-columns: repeat(2,minmax(0,1fr)); } }
    article.definition {
      border-radius:20px;
      background: linear-gradient(155deg, rgba(207,216,220,0.6), rgba(236,239,241,0.75));
      border:1px solid rgba(96,125,139,0.22);
      padding:1.4rem 1.6rem;
      display:grid;
      gap:0.7rem;
    }
    article.definition strong { font-size:1.1rem; color:#263238; }
    .highlight { border-left:6px solid #607d8b; background:rgba(96,125,139,0.12); border-radius:18px; padding:1rem 1.2rem; }
    .code-box { background:#1c262b; color:#cfd8dc; padding:1rem 1.2rem; border-radius:14px; font-family:"Fira Code","Consolas",monospace; font-size:0.95rem; overflow-x:auto; }
    .note { color:#37474f; font-size:0.95rem; }
    .calculator { display:grid; gap:1rem; margin-top:1.1rem; }
    .calculator label { font-weight:600; color:#263238; }
    .calculator input, .calculator select {
      border-radius:14px;
      border:1px solid rgba(96,125,139,0.35);
      padding:0.65rem 0.85rem;
      font-size:1rem;
      background:rgba(248,249,250,0.9);
    }
    .calculator input[type="range"] { padding:0; }
    .calculator button {
      border:none;
      border-radius:999px;
      padding:0.75rem 1.8rem;
      background:linear-gradient(135deg,#455a64,#78909c);
      color:#eceff1;
      font-weight:600;
      cursor:pointer;
      justify-self:flex-start;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .calculator button:hover { transform:translateY(-1px); box-shadow:0 12px 26px rgba(69,90,100,0.3); }
    .result-card {
      border-radius:18px;
      background:rgba(96,125,139,0.15);
      color:#263238;
      padding:1rem 1.3rem;
      font-weight:600;
      display:none;
      gap:0.35rem;
    }
    .table-wrapper { overflow-x:auto; border-radius:16px; border:1px solid rgba(96,125,139,0.22); margin-top:1.3rem; display:none; }
    table.styled { width:100%; border-collapse:collapse; min-width:520px; }
    table.styled th, table.styled td { padding:0.85rem 1.1rem; text-align:center; }
    table.styled thead { background:rgba(176,190,197,0.65); color:#263238; }
    table.styled tbody tr:nth-child(even) { background:rgba(224,230,233,0.65); }
    details.toggle { background:rgba(207,216,220,0.55); border-radius:18px; padding:1rem 1.1rem; border:1px solid rgba(176,190,197,0.6); }
    details.toggle summary { cursor:pointer; font-weight:600; color:#263238; }
    canvas { max-width:100%; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="page">
  <main class="container">
    <header class="hero">
      <h1>บทเรียนที่ 10: การแจกแจงปัวซง (Poisson)</h1>
      <p>แบบจำลองสำหรับการนับจำนวนเหตุการณ์ที่เกิดขึ้นแบบสุ่มภายในขอบเขตที่กำหนด เมื่อเรารู้เพียงอัตราเฉลี่ยต่อช่วงเวลา พื้นที่ หรือปริมาตร</p>
    </header>

    <section class="card" id="concept">
      <h2><span class="badge">Concept</span> นับเหตุการณ์ในขอบเขต</h2>
      <div class="grid two">
        <article class="definition">
          <strong>สูตร PMF</strong>
          <div class="code-box">P(X = x) = \dfrac{e^{-\lambda} \lambda^x}{x!}</div>
          <div class="highlight">
            <ul>
              <li>X: จำนวนเหตุการณ์ที่เกิดขึ้น</li>
              <li>λ (แลมบ์ดา): ค่าเฉลี่ยของเหตุการณ์ต่อช่วง</li>
              <li>ใช้กับเหตุการณ์ที่เกิดอย่างเป็นอิสระและอัตราคงที่</li>
            </ul>
          </div>
        </article>
        <article class="definition">
          <strong>ค่าเฉลี่ย = ความแปรปรวน</strong>
          <div class="code-box">E(X) = \lambda, \quad V(X) = \lambda</div>
          <p class="note">จุดเด่นของปัวซงคือค่าเฉลี่ยเท่ากับความแปรปรวนเสมอ</p>
          <div class="highlight">
            <p>หากต้องการเปลี่ยนขอบเขตเวลา/พื้นที่ ต้องปรับ λ ให้สอดคล้อง เช่น λ = 8 สายต่อชั่วโมง ⇒ λ = 4 สายต่อ 30 นาที</p>
          </div>
        </article>
      </div>
    </section>

    <section class="card" id="playground">
      <h2><span class="badge">Playground</span> เครื่องคิดเลขการแจกแจงปัวซง</h2>
      <div class="calculator">
        <label for="scenario">เลือกสถานการณ์</label>
        <select id="scenario">
          <option value="">-- เลือก --</option>
          <option value="call">ศูนย์บริการรับสายเฉลี่ย 4 สาย/ชม.</option>
          <option value="email">อีเมลเข้ามาเฉลี่ย 12 ฉบับ/วัน</option>
          <option value="defect">จุดบกพร่องเฉลี่ย 2 จุด/ตารางเมตร</option>
        </select>
        <label for="lambda-input">ค่าเฉลี่ยต่อช่วง (λ): <strong id="lambda-display">4.00</strong></label>
        <input type="range" id="lambda-input" min="0.1" max="20" step="0.1" value="4" />
        <label for="x-input">จำนวนเหตุการณ์ที่สนใจ (x)</label>
        <input type="number" id="x-input" value="2" min="0" />
        <button id="calc-btn">คำนวณความน่าจะเป็น</button>
        <button id="cum-btn">คำนวณ P(X &le; x)</button>
      </div>
      <div id="result-card" class="result-card"></div>
      <div id="cum-card" class="result-card" style="margin-top:0.8rem;"></div>
      <div class="table-wrapper" id="table-wrapper">
        <table class="styled" id="poisson-table">
          <thead><tr><th>x</th><th>P(X=x)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <canvas id="poisson-chart" height="260" style="margin-top:1.4rem;"></canvas>
    </section>

    <section class="card" id="example">
      <h2><span class="badge">Example</span> โทรศัพท์เข้า 2 สายใน 1 ชั่วโมง</h2>
      <div class="grid two">
        <article class="definition">
          <strong>โจทย์</strong>
          <p>ศูนย์บริการได้รับโทรศัพท์เฉลี่ย 4 สายต่อชั่วโมง อยากรู้ความน่าจะเป็นที่จะมีสายเข้า 2 สายในชั่วโมงหน้า</p>
          <div class="code-box">λ = 4, x = 2\nP(X=2) = e^{-4} 4^2 / 2! \approx 0.1464\nP(X < 2) = P(0) + P(1) \approx 0.0915</div>
        </article>
        <article class="definition">
          <strong>การตีความ</strong>
          <ul>
            <li>โอกาส 14.64% ที่จะมีสายเข้า 2 สายพอดี</li>
            <li>โอกาส 9.15% ที่จะมีสายเข้าน้อยกว่า 2 สาย</li>
            <li>ค่าเฉลี่ยและความแปรปรวนเท่ากับ 4 สอดคล้องกับลักษณะปัวซง</li>
          </ul>
          <div class="highlight">
            <p>ปัวซงเหมาะกับเหตุการณ์ "นับจำนวน" เช่น ยอดคนเข้าเว็บไซต์ต่อนาที จุดบกพร่องบนผ้า หรือจำนวนรถที่ผ่านสี่แยก</p>
          </div>
        </article>
      </div>
      <details class="toggle" style="margin-top:1.2rem;">
        <summary>Tips</summary>
        <ul>
          <li>หากต้องการ P(X ≥ k) ให้ใช้ 1 − P(X &lt; k)</li>
          <li>เมื่อ λ ใหญ่ (มากกว่า ~10) รูปร่างจะใกล้ปกติ สามารถใช้ Normal Approximation ได้</li>
          <li>หากเหตุการณ์มีโอกาสเกิดสูงในแต่ละครั้ง ควรใช้การแจกแจงอื่นแทน (เช่น Binomial)</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
    const scenarioSelect = document.getElementById('scenario');
    const lambdaInput = document.getElementById('lambda-input');
    const lambdaDisplay = document.getElementById('lambda-display');
    const xInput = document.getElementById('x-input');
    const calcBtn = document.getElementById('calc-btn');
    const cumBtn = document.getElementById('cum-btn');
    const resultCard = document.getElementById('result-card');
    const cumCard = document.getElementById('cum-card');
    const tableWrapper = document.getElementById('table-wrapper');
    const tableBody = document.querySelector('#poisson-table tbody');
    let poissonChart;

    const scenarios = {
      call: { lambda: 4, x: 2 },
      email: { lambda: 12, x: 10 },
      defect: { lambda: 2, x: 0 }
    };

    scenarioSelect.addEventListener('change', () => {
      const sc = scenarios[scenarioSelect.value];
      if (!sc) return;
      lambdaInput.value = sc.lambda;
      xInput.value = sc.x;
      updateLambda();
      calculate();
      calculateCumulative();
    });

    function factorial(n) {
      if (n === 0 || n === 1) return 1;
      let result = 1;
      for (let i = 2; i <= n; i += 1) result *= i;
      return result;
    }

    function poisson(lambda, x) {
      return Math.exp(-lambda) * Math.pow(lambda, x) / factorial(x);
    }

    function updateLambda() {
      const lambda = parseFloat(lambdaInput.value);
      lambdaDisplay.textContent = lambda.toFixed(2);
      xInput.min = 0;
      xInput.step = 1;
      xInput.value = Math.max(0, Math.round(parseFloat(xInput.value) || 0));
    }

    function calculate() {
      const lambda = parseFloat(lambdaInput.value);
      const x = Math.max(0, Math.round(parseFloat(xInput.value) || 0));
      xInput.value = x;
      const probability = poisson(lambda, x);
      resultCard.style.display = 'grid';
      resultCard.innerHTML = `P(X = ${x}) = ${probability.toFixed(6)} | E(X) = ${lambda.toFixed(3)} | V(X) = ${lambda.toFixed(3)}`;
      buildTable(lambda, x);
    }

    function calculateCumulative() {
      const lambda = parseFloat(lambdaInput.value);
      const x = Math.max(0, Math.round(parseFloat(xInput.value) || 0));
      let sum = 0;
      for (let i = 0; i <= x; i += 1) {
        sum += poisson(lambda, i);
      }
      cumCard.style.display = 'grid';
      cumCard.innerHTML = `P(X \u2264 ${x}) = ${sum.toFixed(6)} | P(X > ${x}) = ${(1 - sum).toFixed(6)}`;
    }

    function buildTable(lambda, highlightX) {
      tableBody.innerHTML = '';
      const labels = [];
      const data = [];
      const maxX = Math.min(30, Math.max(highlightX + 5, Math.ceil(lambda + 4 * Math.sqrt(lambda))));
      for (let i = 0; i <= maxX; i += 1) {
        const prob = poisson(lambda, i);
        labels.push(i);
        data.push(prob);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i}</td><td>${prob.toFixed(6)}</td>`;
        if (i === highlightX) tr.style.background = 'rgba(176,190,197,0.8)';
        tableBody.appendChild(tr);
      }
      tableWrapper.style.display = 'block';
      renderChart(labels, data, highlightX);
    }

    function renderChart(labels, data, highlightX) {
      const ctx = document.getElementById('poisson-chart');
      if (poissonChart) poissonChart.destroy();
      poissonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'P(X = x)',
            data,
            backgroundColor: labels.map(x => x === highlightX ? 'rgba(120,144,156,0.7)' : 'rgba(176,190,197,0.6)'),
            borderColor: '#455a64',
            borderWidth: 1.5,
            borderRadius: 10
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { title: { display: true, text: 'จำนวนเหตุการณ์ (x)', color: '#37474f' } },
            y: {
              beginAtZero: true,
              title: { display: true, text: 'ความน่าจะเป็น', color: '#37474f' }
            }
          }
        }
      });
    }

    lambdaInput.addEventListener('input', () => { updateLambda(); calculate(); calculateCumulative(); });
    xInput.addEventListener('change', () => { calculate(); calculateCumulative(); });
    calcBtn.addEventListener('click', () => { calculate(); });
    cumBtn.addEventListener('click', calculateCumulative);

    updateLambda();
    calculate();
    calculateCumulative();
  </script>
</body>
</html>
