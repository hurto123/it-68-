<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>บทที่ 21: การคำนวณขนาดตัวอย่าง</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    :root { color-scheme: light dark; }
    body.page {
      --accent: #0277bd;
      --accent-light: #29b6f6;
      --accent-dark: #01579b;
      --card-bg: rgba(227, 242, 253, 0.94);
      font-family: "IBM Plex Sans Thai", "Prompt", "Sarabun", system-ui, sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at 18% 22%, rgba(41, 182, 246, 0.28), transparent 60%),
                  radial-gradient(circle at 80% 18%, rgba(2, 119, 189, 0.2), transparent 60%),
                  linear-gradient(180deg, rgba(225, 245, 254, 0.92), rgba(232, 245, 255, 0.9));
    }
    main.container { max-width: 1120px; margin: 0 auto; padding: clamp(2rem, 5vw, 3.5rem); display: grid; gap: 2.2rem; }
    header.hero { background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: #fff; padding: clamp(2.6rem, 6vw, 4rem); border-radius: 32px; position: relative; overflow: hidden; box-shadow: 0 32px 54px rgba(2, 119, 189, 0.25); }
    header.hero::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 78% 18%, rgba(255,255,255,0.45), transparent 55%), radial-gradient(circle at 20% 75%, rgba(255,255,255,0.24), transparent 70%); }
    header.hero h1 { font-size: clamp(2.4rem, 3vw + 1.5rem, 3.6rem); margin-bottom: 0.75rem; }
    header.hero p { font-size: 1.12rem; max-width: 720px; line-height: 1.7; }
    section.card { background: var(--card-bg); border-radius: 26px; padding: clamp(1.8rem, 4vw, 2.6rem); box-shadow: 0 20px 36px rgba(1, 87, 155, 0.16); backdrop-filter: blur(6px); display: grid; gap: 1.1rem; }
    section.card h2 { color: var(--accent); font-size: 1.9rem; display: flex; align-items: center; gap: 0.75rem; margin: 0; }
    .badge { background: rgba(2, 119, 189, 0.12); color: var(--accent-dark); padding: 0.2rem 0.8rem; border-radius: 999px; font-size: 0.9rem; font-weight: 600; }
    .grid { display: grid; gap: 1.2rem; }
    @media (min-width: 960px) { .grid.two { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    article.definition { padding: 1.35rem 1.6rem; border-radius: 20px; background: rgba(187, 222, 251, 0.85); border: 1px solid rgba(2, 119, 189, 0.18); display: grid; gap: 0.6rem; }
    article.definition strong { color: var(--accent-dark); font-size: 1.05rem; }
    .highlight { border-left: 6px solid var(--accent); padding: 1rem 1.25rem; background: rgba(2, 136, 209, 0.12); border-radius: 18px; line-height: 1.7; }
    .calculator { display: grid; gap: 1rem; margin-top: 0.8rem; }
    .calculator label { font-weight: 600; color: var(--accent-dark); display: grid; gap: 0.4rem; }
    .calculator input, .calculator select {
      padding: 0.75rem 1rem;
      border-radius: 14px;
      border: 1px solid rgba(2, 119, 189, 0.28);
      font-size: 1rem;
      background: rgba(255,255,255,0.95);
    }
    .calculator button {
      background: linear-gradient(135deg, var(--accent-dark), var(--accent));
      color: #fff;
      border: 0;
      border-radius: 14px;
      padding: 0.85rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .calculator button:hover { transform: translateY(-2px); box-shadow: 0 16px 30px rgba(1, 87, 155, 0.24); }
    .result-card { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 1.2rem 1.4rem; border: 1px solid rgba(2, 136, 209, 0.2); display: grid; gap: 0.6rem; }
    canvas { background: rgba(255,255,255,0.88); border-radius: 18px; padding: 1rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.6rem 0.75rem; text-align: left; }
    th { background: rgba(187, 222, 251, 0.5); color: var(--accent-dark); }
    tr:nth-child(even) { background: rgba(227, 242, 253, 0.6); }
  </style>
</head>
<body class="page">
  <main class="container">
    <header class="hero">
      <span class="badge">Design Stage</span>
      <h1>บทที่ 21: การคำนวณขนาดตัวอย่าง (Sample Size Determination)</h1>
      <p>กำหนดจำนวนตัวอย่างที่เหมาะสมเพื่อให้การประมาณหรือการทดสอบสมมติฐานมีพลังและความแม่นยำตามต้องการ พร้อมเครื่องคิดเลขที่ช่วยเชื่อมโยงระหว่างความเชื่อมั่น ขอบเขตผิดพลาด และพลังการทดสอบ.</p>
    </header>

    <section class="card">
      <h2>1. ปัจจัยที่ต้องพิจารณา</h2>
      <div class="grid two">
        <article class="definition">
          <strong>ระดับความเชื่อมั่น / ความเสี่ยง (α)</strong>
          <p>ความต้องการความเชื่อมั่นสูง → ต้องการตัวอย่างมากขึ้น เพราะช่วงความเชื่อมั่นหรือพลังการทดสอบต้องครอบคลุมความไม่แน่นอนมากขึ้น</p>
        </article>
        <article class="definition">
          <strong>ขอบเขตผิดพลาดที่ยอมรับได้ (E)</strong>
          <p>ต้องการความละเอียดสูง (E เล็ก) → ต้องใช้ตัวอย่างเพิ่มขึ้น เพื่อให้ช่วงความเชื่อมั่นแคบลง</p>
        </article>
      </div>
      <div class="highlight">
        <strong>องค์ประกอบอื่นๆ</strong> เช่น ความแปรปรวนของข้อมูล (σ หรือ p(1-p)) และพลังการทดสอบ (1-β) หากออกแบบสำหรับการทดสอบสมมติฐาน
      </div>
    </section>

    <section class="card">
      <h2>2. สูตรพื้นฐาน</h2>
      <div class="grid two">
        <article class="definition">
          <strong>สำหรับค่าเฉลี่ย</strong>
          <p>\[ n = \left( \dfrac{z_{\alpha/2}\, \sigma}{E} \right)^2 \]</p>
          <p>เมื่อไม่รู้ σ ให้ใช้ค่าประมาณจากข้อมูลก่อนหน้า หรือใช้ s ของตัวอย่างนำร่อง</p>
        </article>
        <article class="definition">
          <strong>สำหรับสัดส่วน</strong>
          <p>\[ n = \dfrac{z_{\alpha/2}^2 p(1-p)}{E^2} \]</p>
          <p>หากไม่รู้ p ให้ใช้ 0.5 (กรณีรุนแรงที่สุด) เพื่อให้ได้ขนาดตัวอย่างสูงสุด</p>
        </article>
      </div>
    </section>

    <section class="card">
      <h2>3. เครื่องคิดเลขขนาดตัวอย่าง</h2>
      <p>เลือกประเภทปริมาณ เลือกค่าที่ต้องการ แล้วระบบจะคำนวณ n พร้อมแสดงการเปลี่ยนแปลงเมื่อปรับพารามิเตอร์.</p>
      <div class="calculator">
        <label>ประเภทการออกแบบ
          <select id="mode">
            <option value="mean">ค่าเฉลี่ย (μ)</option>
            <option value="prop">สัดส่วน (p)</option>
          </select>
        </label>
        <label>ระดับความเชื่อมั่น (%)
          <input type="range" id="conf" min="80" max="99" value="95" />
        </label>
        <div class="note">ระดับความเชื่อมั่น: <span id="conf-text">95%</span></div>
        <label id="sigma-label">ส่วนเบี่ยงเบนมาตรฐาน (σ)
          <input type="number" id="sigma" value="12" step="0.01" min="0" />
        </label>
        <label id="p-label" style="display:none">ประมาณการสัดส่วน (p)
          <input type="number" id="phat" value="0.5" step="0.01" min="0" max="1" />
        </label>
        <label>ขอบเขตผิดพลาดสูงสุดที่ยอมรับ (E)
          <input type="number" id="margin" value="3" step="0.01" min="0.0001" />
        </label>
        <button id="calc">คำนวณขนาดตัวอย่าง</button>
      </div>
      <div class="result-card" id="summary" style="display:none"></div>
      <canvas id="ss-chart" height="220"></canvas>
    </section>

    <section class="card">
      <h2>4. ตารางเปรียบเทียบอย่างรวดเร็ว</h2>
      <table>
        <thead>
          <tr>
            <th>กรณีศึกษา</th>
            <th>พารามิเตอร์</th>
            <th>ขนาดตัวอย่างที่ต้องการ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>สำรวจคะแนนความพึงพอใจ (σ ≈ 8, E = 1.5, 95%)</td>
            <td>z = 1.96</td>
            <td>≈ 109 คน</td>
          </tr>
          <tr>
            <td>สำรวจอัตราผู้ใช้ฟีเจอร์ใหม่ (p ≈ 0.4, E = 0.05, 95%)</td>
            <td>z = 1.96</td>
            <td>≈ 369 ตัวอย่าง</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="card">
      <h2>5. Checklist ก่อนเก็บข้อมูล</h2>
      <ul>
        <li>✅ ระบุวัตถุประสงค์ชัดเจน (ประมาณค่า / ทดสอบ)</li>
        <li>✅ เลือกระดับความเชื่อมั่นและพลังการทดสอบ</li>
        <li>✅ มีการประมาณ σ หรือ p จากข้อมูลเดิม/นำร่อง</li>
        <li>✅ พิจารณาอัตราการสูญหายของตัวอย่าง (non-response)</li>
        <li>✅ เพิ่มตัวอย่างเผื่อการวิเคราะห์ย่อย (subgroup)</li>
      </ul>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstat@1.9.5/dist/jstat.min.js"></script>
  <script>
    const modeSelect = document.getElementById('mode');
    const confInput = document.getElementById('conf');
    const confText = document.getElementById('conf-text');
    const sigmaRow = document.getElementById('sigma-label');
    const sigmaInput = document.getElementById('sigma');
    const pRow = document.getElementById('p-label');
    const pInput = document.getElementById('phat');
    const marginInput = document.getElementById('margin');
    const calcBtn = document.getElementById('calc');
    const summary = document.getElementById('summary');
    const ctx = document.getElementById('ss-chart');
    let chart;

    function toggleFields() {
      if (modeSelect.value === 'mean') {
        sigmaRow.style.display = 'grid';
        pRow.style.display = 'none';
      } else {
        sigmaRow.style.display = 'none';
        pRow.style.display = 'grid';
      }
    }

    function updateChart(baseValue, z, type) {
      const points = 20;
      const labels = [];
      const data = [];
      for (let i = 1; i <= points; i += 1) {
        const margin = baseValue / (i * 0.3 + 0.7);
        let n;
        if (type === 'mean') {
          n = Math.pow((z * sigmaInput.value) / margin, 2);
        } else {
          const p = pInput.value;
          n = (z * z * p * (1 - p)) / (margin * margin);
        }
        labels.push((margin).toFixed(2));
        data.push(Math.ceil(n));
      }
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'n ที่ต้องการเมื่อปรับ E',
            data,
            borderColor: 'rgba(2,119,189,0.85)',
            backgroundColor: 'rgba(41,182,246,0.3)',
            borderWidth: 2,
            pointRadius: 4,
            fill: true,
            tension: 0.25
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#01579b' } } },
          scales: {
            x: { title: { display: true, text: 'ขอบเขตผิดพลาด (E)', color: '#01579b' }, ticks: { color: '#01579b' } },
            y: { title: { display: true, text: 'ขนาดตัวอย่างโดยประมาณ', color: '#01579b' }, ticks: { color: '#01579b' } }
          }
        }
      });
    }

    function calculate() {
      const confidence = parseInt(confInput.value, 10) / 100;
      confText.textContent = `${(confidence * 100).toFixed(0)}%`;
      const alpha = 1 - confidence;
      const z = jStat.normal.inv(1 - alpha / 2, 0, 1);
      const E = Math.max(parseFloat(marginInput.value), 1e-6);
      let n;
      let detail;
      if (modeSelect.value === 'mean') {
        const sigma = Math.max(parseFloat(sigmaInput.value), 1e-6);
        n = Math.pow((z * sigma) / E, 2);
        detail = `z = ${z.toFixed(3)}, σ = ${sigma.toFixed(3)}, E = ${E.toFixed(3)}`;
      } else {
        const p = Math.min(Math.max(parseFloat(pInput.value), 0), 1);
        pInput.value = p;
        n = (z * z * p * (1 - p)) / (E * E);
        detail = `z = ${z.toFixed(3)}, p = ${p.toFixed(3)}, E = ${E.toFixed(3)}`;
      }
      const nCeil = Math.ceil(n);
      summary.style.display = 'grid';
      summary.innerHTML = `
        <strong>ขนาดตัวอย่างที่ต้องการ</strong>
        <span>${modeSelect.value === 'mean' ? 'สำหรับค่าเฉลี่ย' : 'สำหรับสัดส่วน'}: n = ${n.toFixed(2)} → ปัดขึ้นเป็น ${nCeil}</span>
        <span>${detail}</span>
        <span class="note">เพิ่มตัวอย่างเผื่อข้อมูลสูญหายหรือกรณีวิเคราะห์ย่อยประมาณ 5–15%</span>
      `;

      updateChart(E, z, modeSelect.value);
    }

    modeSelect.addEventListener('change', () => {
      toggleFields();
      calculate();
    });
    confInput.addEventListener('input', () => { confText.textContent = `${confInput.value}%`; });
    [sigmaInput, pInput, marginInput].forEach(el => el.addEventListener('input', calculate));
    confInput.addEventListener('change', calculate);
    calcBtn.addEventListener('click', calculate);

    toggleFields();
    calculate();
  </script>
</body>
</html>
