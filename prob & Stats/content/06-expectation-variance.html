<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>บทที่ 6: ค่าคาดหวังและความแปรปรวน</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    :root {
      color-scheme: light dark;
    }
    body.page {
      min-height: 100vh;
      background: radial-gradient(circle at 15% 15%, rgba(209,196,233,0.55), transparent 60%),
                  radial-gradient(circle at 85% 20%, rgba(179,157,219,0.55), transparent 65%),
                  linear-gradient(180deg, rgba(237,231,246,0.9), rgba(232,234,246,0.9));
      font-family: "IBM Plex Sans Thai", "Prompt", "Sarabun", system-ui, sans-serif;
    }
    main.container {
      max-width: 1100px;
      margin: 0 auto;
      padding: clamp(2rem, 5vw, 3.5rem);
    }
    header.hero {
      background: linear-gradient(135deg, #5e35b1, #7e57c2);
      color: #fff;
      padding: clamp(2.8rem, 6vw, 4rem);
      border-radius: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 30px 54px rgba(94,53,177,0.28);
      margin-bottom: 2.4rem;
    }
    header.hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 78% 15%, rgba(255,255,255,0.4), transparent 60%),
                  radial-gradient(circle at 20% 70%, rgba(255,255,255,0.22), transparent 70%);
    }
    header.hero h1 {
      font-size: clamp(2.4rem, 3vw + 1.5rem, 3.6rem);
      margin-bottom: 0.75rem;
    }
    header.hero p {
      font-size: 1.1rem;
      max-width: 720px;
      line-height: 1.7;
    }
    section.card {
      background: rgba(255,255,255,0.93);
      border-radius: 26px;
      padding: clamp(1.7rem, 4vw, 2.7rem);
      margin-bottom: 2.2rem;
      box-shadow: 0 20px 36px rgba(81,45,168,0.15);
      backdrop-filter: blur(6px);
    }
    section.card h2 {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #4527a0;
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .badge {
      border-radius: 999px;
      padding: 0.15rem 0.85rem;
      background: rgba(209,196,233,0.7);
      color: #311b92;
      font-weight: 600;
    }
    .grid {
      display: grid;
      gap: 1.4rem;
    }
    @media (min-width: 920px) {
      .grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .grid.three { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    article.definition {
      border-radius: 20px;
      padding: 1.4rem 1.6rem;
      background: linear-gradient(155deg, rgba(209,196,233,0.6), rgba(237,231,246,0.8));
      border: 1px solid rgba(94,53,177,0.18);
      display: grid;
      gap: 0.7rem;
    }
    article.definition strong {
      font-size: 1.1rem;
      color: #4527a0;
    }
    .highlight {
      border-left: 6px solid #673ab7;
      padding: 1rem 1.25rem;
      background: rgba(103,58,183,0.12);
      border-radius: 18px;
    }
    .note {
      color: #4527a0;
      font-size: 0.95rem;
    }
    .code-box {
      background: #1c1730;
      color: #d1c4e9;
      padding: 1rem 1.2rem;
      border-radius: 14px;
      font-family: "Fira Code", "Consolas", monospace;
      font-size: 0.95rem;
      overflow-x: auto;
    }
    .calculator {
      display: grid;
      gap: 1rem;
      margin-top: 1.1rem;
    }
    .calculator label {
      font-weight: 600;
      color: #311b92;
    }
    .calculator input,
    .calculator textarea,
    .calculator select {
      border-radius: 14px;
      border: 1px solid rgba(94,53,177,0.3);
      padding: 0.7rem 0.9rem;
      font-size: 1rem;
      background: rgba(247,245,255,0.9);
    }
    .calculator textarea {
      min-height: 80px;
      resize: vertical;
    }
    .calculator button {
      border: none;
      border-radius: 999px;
      padding: 0.8rem 1.8rem;
      background: linear-gradient(130deg, #5e35b1, #9575cd);
      color: #f3e5f5;
      font-weight: 600;
      cursor: pointer;
      justify-self: flex-start;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .calculator button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(94,53,177,0.32);
    }
    .result-card {
      border-radius: 18px;
      background: rgba(103,58,183,0.12);
      color: #311b92;
      padding: 1.1rem 1.3rem;
      font-weight: 600;
      display: grid;
      gap: 0.35rem;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 16px;
      border: 1px solid rgba(94,53,177,0.18);
    }
    table.styled {
      width: 100%;
      border-collapse: collapse;
      min-width: 480px;
    }
    table.styled th,
    table.styled td {
      padding: 0.85rem 1.1rem;
      text-align: left;
    }
    table.styled thead {
      background: rgba(209,196,233,0.6);
      color: #311b92;
    }
    table.styled tbody tr:nth-child(even) {
      background: rgba(237,231,246,0.6);
    }
    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.65rem;
    }
    .pill {
      padding: 0.35rem 0.9rem;
      background: rgba(179,157,219,0.45);
      border-radius: 999px;
      color: #311b92;
      font-weight: 600;
      font-size: 0.9rem;
    }
    details.toggle {
      background: rgba(209,196,233,0.45);
      border-radius: 18px;
      padding: 1rem 1.1rem;
      border: 1px solid rgba(179,157,219,0.5);
    }
    details.toggle summary {
      cursor: pointer;
      font-weight: 600;
      color: #4527a0;
    }
    canvas {
      max-width: 100%;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="page">
  <main class="container">
    <header class="hero">
      <h1>บทเรียนที่ 6: ค่าคาดหวังและความแปรปรวน</h1>
      <p>สรุปสาระของการแจกแจงความน่าจะเป็นผ่านตัวเลขสำคัญสองค่า: <strong>ค่าคาดหวัง</strong> ที่บอกจุดศูนย์กลาง และ <strong>ความแปรปรวน</strong> ที่บอกการกระจายตัวของค่ารอบๆ ค่าเฉลี่ย พร้อมเครื่องมือคำนวณและกราฟโต้ตอบเพื่อเห็นภาพอย่างชัดเจน</p>
    </header>

    <section class="card" id="summary">
      <h2><span class="badge">Step 1</span> ค่าสรุปย่อที่สำคัญ</h2>
      <div class="grid two">
        <article class="definition">
          <strong>ค่าคาดหวัง (Expected Value)</strong>
          <p>ค่าเฉลี่ยถ่วงน้ำหนักด้วยความน่าจะเป็น บอกตำแหน่งที่เราคาดว่าจะพบค่าโดยเฉลี่ยหากทดลองซ้ำจำนวนมาก</p>
          <div class="highlight">
            <ul>
              <li>สัญลักษณ์: <strong>E(X)</strong> หรือ <strong>μ</strong></li>
              <li>สำหรับตัวแปรไม่ต่อเนื่อง: E(X) = ∑ x·f(x)</li>
              <li>สำหรับตัวแปรต่อเนื่อง: E(X) = ∫ x·f(x) dx</li>
            </ul>
          </div>
        </article>
        <article class="definition">
          <strong>ความแปรปรวน (Variance)</strong>
          <p>วัดว่าค่าของตัวแปรสุ่มกระจายตัวไกลจากค่าเฉลี่ยมากน้อยเพียงใด ยิ่งมากยิ่งผันผวน</p>
          <div class="highlight">
            <ul>
              <li>สัญลักษณ์: <strong>V(X)</strong> หรือ <strong>σ²</strong></li>
              <li>นิยาม: V(X) = E[(X−μ)²]</li>
              <li>สูตรคำนวณ: V(X) = E(X²) − [E(X)]²</li>
              <li>ส่วนเบี่ยงเบนมาตรฐาน: σ = √V(X)</li>
            </ul>
          </div>
        </article>
      </div>
      <div class="pill-list" style="margin-top:1.4rem;">
        <span class="pill">E(X) บอก <strong>ตำแหน่ง</strong></span>
        <span class="pill">V(X) บอก <strong>ความกว้าง</strong></span>
        <span class="pill">σ อยู่ในหน่วยเดียวกับ X</span>
      </div>
    </section>

    <section class="card" id="formulas">
      <h2><span class="badge">Step 2</span> สูตรสำคัญที่ต้องจำ</h2>
      <div class="grid two">
        <article class="definition">
          <strong>ตัวแปรไม่ต่อเนื่อง</strong>
          <div class="code-box">E(X) = \sum x f(x)\nE(X^2) = \sum x^2 f(x)\nV(X) = E(X^2) - [E(X)]^2</div>
          <p class="note">ใช้ผลรวมของค่าที่เป็นไปได้ทุกค่า คูณกับความน่าจะเป็นของแต่ละค่าก่อนรวมกัน</p>
        </article>
        <article class="definition">
          <strong>ตัวแปรต่อเนื่อง</strong>
          <div class="code-box">E(X) = \int_{-\infty}^{\infty} x f(x) dx\nV(X) = \int (x-\mu)^2 f(x) dx</div>
          <p class="note">เปลี่ยนเครื่องหมาย ∑ เป็น ∫ และมองความน่าจะเป็นเป็น "พื้นที่ใต้กราฟ"</p>
        </article>
      </div>
      <details class="toggle" style="margin-top:1.2rem;">
        <summary>เคล็ดลับ: ใช้สูตรลัด V(X) = E(X²) - [E(X)]²</summary>
        <p>ขั้นตอน: (1) คำนวณ E(X) ตามปกติ (2) คำนวณ E(X²) โดยยกกำลังสองค่าก่อนคูณความน่าจะเป็น (3) นำ E(X²) − [E(X)]² จะได้ความแปรปรวนทันที ช่วยลดการคำนวณแบบยาวๆ ได้มาก</p>
      </details>
    </section>

    <section class="card" id="calculator">
      <h2><span class="badge">Step 3</span> เครื่องคิดเลขค่าคาดหวัง + ความแปรปรวน</h2>
      <p>ป้อนค่าที่เป็นไปได้ของตัวแปรสุ่ม (x) และความน่าจะเป็น f(x) ในรูปแบบคั่นด้วยเครื่องหมายจุลภาค ระบบจะช่วยตรวจสอบว่า PMF ถูกต้องหรือไม่ พร้อมสรุป E(X), E(X²), V(X) และ σ</p>
      <div class="calculator">
        <label for="preset">เลือกสถานการณ์ตัวอย่าง</label>
        <select id="preset">
          <option value="">-- เลือก --</option>
          <option value="coin2">โยนเหรียญ 2 ครั้ง (X = จำนวนหัว)</option>
          <option value="game">เกมเหรียญ 1 อัน (ได้ 10 / เสีย 5)</option>
          <option value="dice">ทอดลูกเต๋า (X = แต้ม)</option>
        </select>
        <label for="x-values">ค่า x (คั่นด้วย , )</label>
        <textarea id="x-values" placeholder="เช่น 0,1,2"></textarea>
        <label for="p-values">ความน่าจะเป็น f(x) (คั่นด้วย , )</label>
        <textarea id="p-values" placeholder="เช่น 0.25,0.5,0.25"></textarea>
        <button id="calc-btn">คำนวณค่าคาดหวังและความแปรปรวน</button>
      </div>
      <div id="calc-message" class="result-card" style="display:none; margin-top:1.2rem;"></div>
      <div class="table-wrapper" style="margin-top:1.2rem; display:none;" id="calc-table-wrapper">
        <table class="styled" id="calc-table">
          <thead>
            <tr><th>x</th><th>f(x)</th><th>x·f(x)</th><th>x²·f(x)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <canvas id="pmf-chart" height="220" style="margin-top:1.8rem;"></canvas>
    </section>

    <section class="card" id="interpretation">
      <h2><span class="badge">Step 4</span> ทำไมความแปรปรวนถึงสำคัญ?</h2>
      <p>กราฟด้านล่างแสดงการเปรียบเทียบการแจกแจงสองชุดที่มีค่าเฉลี่ยเท่ากัน (μ = 5) แต่มีความแปรปรวนต่างกัน ปรับตัวเลื่อนเพื่อเห็นว่าการกระจายตัวเปลี่ยนไปอย่างไร</p>
      <label for="variance-slider" style="font-weight:600; color:#311b92;">ปรับความแปรปรวนของกราฟสีชมพู: <span id="variance-value">2.0</span></label>
      <input type="range" id="variance-slider" min="0.5" max="5" step="0.1" value="2" style="width:100%;" />
      <canvas id="variance-chart" height="280" style="margin-top:1.4rem;"></canvas>
      <div class="highlight" style="margin-top:1.4rem;">
        <ul>
          <li>กราฟสีม่วงอ่อน (σ² = 1) มีเส้นสูงชัน บ่งบอกค่าที่เกาะกลุ่ม</li>
          <li>เมื่อเพิ่มความแปรปรวน กราฟจะเตี้ยและกว้างขึ้น แสดงค่าที่กระจายห่างออกไป</li>
          <li>ส่วนเบี่ยงเบนมาตรฐาน (σ) คือรากที่สองของความแปรปรวน ทำให้ตีความได้ในหน่วยเดียวกับตัวแปร</li>
        </ul>
      </div>
    </section>

    <section class="card" id="examples">
      <h2><span class="badge">Step 5</span> ตัวอย่างสรุป</h2>
      <div class="grid two">
        <article class="definition">
          <strong>เกมโยนเหรียญ (ได้ 10 / เสีย 5)</strong>
          <p>ใช้สูตร E(X) = ∑ x·f(x)</p>
          <div class="code-box">E(X) = (10)(0.5) + (-5)(0.5) = 2.5\nE(X^2) = 100(0.5) + 25(0.5) = 62.5\nV(X) = 62.5 - 2.5^2 = 56.25</div>
          <p class="note">ค่าเฉลี่ยบวก (กำไรเฉลี่ย 2.5) แต่ความแปรปรวนสูง แปลว่าความเสี่ยงต่อครั้งยังคงมาก</p>
        </article>
        <article class="definition">
          <strong>โยนเหรียญ 2 ครั้ง (X = จำนวนหัว)</strong>
          <div class="code-box">f(0)=1/4, f(1)=2/4, f(2)=1/4\nE(X) = 1\nE(X^2) = 1.5\nV(X) = 1.5 - 1^2 = 0.5</div>
          <p class="note">ส่วนเบี่ยงเบนมาตรฐาน ≈ 0.707 หมายถึงค่าจะอยู่ใกล้ 1 ส่วนใหญ่</p>
        </article>
      </div>
      <details class="toggle" style="margin-top:1.3rem;">
        <summary>ข้อควรระวัง</summary>
        <ul>
          <li>PMF ต้องรวมกันได้ 1 เสมอ หากไม่ครบให้ปรับหรือเช็กการปัดเศษ</li>
          <li>ค่าคาดหวังไม่จำเป็นต้องเป็นค่าที่เกิดขึ้นจริง (เช่น 3.5 จากลูกเต๋า)</li>
          <li>ความแปรปรวนไม่เคยติดลบ เพราะเป็นผลรวมของกำลังสอง</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
    const presetSelect = document.getElementById('preset');
    const xInput = document.getElementById('x-values');
    const pInput = document.getElementById('p-values');
    const calcBtn = document.getElementById('calc-btn');
    const messageEl = document.getElementById('calc-message');
    const tableWrapper = document.getElementById('calc-table-wrapper');
    const tableBody = document.querySelector('#calc-table tbody');
    let pmfChart;

    const presets = {
      coin2: {
        x: ['0', '1', '2'],
        p: ['0.25', '0.5', '0.25']
      },
      game: {
        x: ['10', '-5'],
        p: ['0.5', '0.5']
      },
      dice: {
        x: ['1','2','3','4','5','6'],
        p: ['0.1667','0.1667','0.1667','0.1667','0.1667','0.1667']
      }
    };

    presetSelect.addEventListener('change', () => {
      const option = presets[presetSelect.value];
      if (!option) return;
      xInput.value = option.x.join(',');
      pInput.value = option.p.join(',');
    });

    function formatNumber(num) {
      return Number.isFinite(num) ? Number(num.toFixed(6)).toString() : 'NaN';
    }

    calcBtn.addEventListener('click', () => {
      const xs = xInput.value.split(',').map(v => v.trim()).filter(Boolean).map(Number);
      const ps = pInput.value.split(',').map(v => v.trim()).filter(Boolean).map(Number);

      if (!xs.length || xs.length !== ps.length) {
        showMessage('กรุณากรอกค่า x และ f(x) ให้ครบถ้วน และมีจำนวนเท่ากัน', true);
        return;
      }

      if (ps.some(p => p < 0 || !Number.isFinite(p))) {
        showMessage('ความน่าจะเป็นต้องเป็นตัวเลขที่ไม่ติดลบ', true);
        return;
      }

      const sumP = ps.reduce((acc, cur) => acc + cur, 0);
      if (Math.abs(sumP - 1) > 1e-4) {
        showMessage(`คำเตือน: ผลรวมของความน่าจะเป็น = ${formatNumber(sumP)} (ไม่เท่ากับ 1)`, true);
      } else {
        showMessage('PMF ถูกต้อง! ผลรวมของ f(x) = 1', false);
      }

      tableBody.innerHTML = '';
      let ex = 0;
      let ex2 = 0;
      xs.forEach((x, idx) => {
        const p = ps[idx];
        const xp = x * p;
        const x2p = x * x * p;
        ex += xp;
        ex2 += x2p;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x}</td><td>${formatNumber(p)}</td><td>${formatNumber(xp)}</td><td>${formatNumber(x2p)}</td>`;
        tableBody.appendChild(tr);
      });
      const variance = ex2 - ex * ex;
      const sd = Math.sqrt(Math.max(variance, 0));
      const summaryHtml = `E(X) = <strong>${formatNumber(ex)}</strong> | E(X^2) = <strong>${formatNumber(ex2)}</strong> | V(X) = <strong>${formatNumber(variance)}</strong> | σ = <strong>${formatNumber(sd)}</strong>`;
      messageEl.innerHTML = summaryHtml;
      messageEl.style.display = 'grid';
      tableWrapper.style.display = 'block';
      renderPMFChart(xs, ps);
    });

    function showMessage(msg, isWarn) {
      messageEl.innerHTML = msg;
      messageEl.style.display = 'grid';
      messageEl.style.background = isWarn ? 'rgba(244,143,177,0.22)' : 'rgba(103,58,183,0.12)';
      messageEl.style.color = isWarn ? '#ad1457' : '#311b92';
    }

    function renderPMFChart(xs, ps) {
      const ctx = document.getElementById('pmf-chart');
      if (pmfChart) pmfChart.destroy();
      pmfChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: xs,
          datasets: [{
            label: 'f(x)',
            data: ps,
            backgroundColor: 'rgba(126,87,194,0.6)',
            borderColor: '#5e35b1',
            borderWidth: 1.5,
            borderRadius: 12
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Probability', color: '#4527a0' }
            }
          }
        }
      });
    }

    // Variance chart for normal curves
    const varianceCtx = document.getElementById('variance-chart');
    const varianceSlider = document.getElementById('variance-slider');
    const varianceValue = document.getElementById('variance-value');

    function normalPdf(x, mean, variance) {
      const sd = Math.sqrt(variance);
      const coeff = 1 / (sd * Math.sqrt(2 * Math.PI));
      return coeff * Math.exp(-0.5 * ((x - mean) / sd) ** 2);
    }

    const xDomain = Array.from({ length: 121 }, (_, idx) => 0 + idx * 0.1);
    const baseData = xDomain.map(x => normalPdf(x, 5, 1));

    const varianceChart = new Chart(varianceCtx, {
      type: 'line',
      data: {
        labels: xDomain,
        datasets: [
          {
            label: 'σ² = 1',
            data: baseData,
            borderColor: '#5e35b1',
            backgroundColor: 'rgba(94,53,177,0.18)',
            borderWidth: 2,
            tension: 0.25,
            fill: true
          },
          {
            label: 'σ² ปรับค่า',
            data: xDomain.map(x => normalPdf(x, 5, parseFloat(varianceSlider.value))),
            borderColor: '#ec407a',
            backgroundColor: 'rgba(236,64,122,0.18)',
            borderWidth: 2,
            tension: 0.25,
            fill: true
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: { color: '#311b92' }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'ค่า X', color: '#311b92' }
          },
          y: {
            title: { display: true, text: 'ความหนาแน่น (PDF)', color: '#311b92' },
            beginAtZero: true
          }
        }
      }
    });

    varianceSlider.addEventListener('input', () => {
      const variance = parseFloat(varianceSlider.value);
      varianceValue.textContent = variance.toFixed(1);
      varianceChart.data.datasets[1].data = xDomain.map(x => normalPdf(x, 5, variance));
      varianceChart.update();
    });
  </script>
</body>
</html>
