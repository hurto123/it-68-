<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>บทที่ 21 • การคำนวณขนาดตัวอย่าง (Sample Size)</title>
  <meta name="description" content="เรียนรู้การคำนวณขนาดตัวอย่างสำหรับการประมาณค่าเฉลี่ยและสัดส่วน พร้อมเครื่องมือปรับค่าความเชื่อมั่นและระยะเผื่อความคลาดเคลื่อน" />
  <link rel="stylesheet" href="assets/lesson-theme.css" />
</head>
<body>
  <main class="page">
    <header class="hero">
      <span class="badge">บทเรียนที่ 21</span>
      <h1>การคำนวณขนาดตัวอย่างที่เหมาะสม</h1>
      <p class="lead">
        วางแผนก่อนเก็บข้อมูล—เลือกจำนวนตัวอย่างให้ “พอดี” กับงบประมาณและระดับความแม่นยำที่ต้องการ เพื่อให้ผลการประมาณมีพลังทางสถิติที่เพียงพอ
      </p>
      <div class="stat-grid">
        <div class="stat">
          <span class="label">ปัจจัยหลัก</span>
          <span class="value">Z, การกระจาย, Margin</span>
        </div>
        <div class="stat">
          <span class="label">คำเตือน</span>
          <span class="value">ปัดขึ้นเสมอ</span>
        </div>
        <div class="stat">
          <span class="label">โฟกัส</span>
          <span class="value">E (ระยะเผื่อความคลาดเคลื่อน)</span>
        </div>
      </div>
    </header>

    <section class="card">
      <h2>1. ทำไมต้องวางแผนขนาดตัวอย่าง</h2>
      <p>
        ถ้าน้อยเกินไป ผลลัพธ์ไม่น่าเชื่อถือ ถ้าเยอะเกินไปสิ้นเปลืองทรัพยากร การคำนวณขนาดตัวอย่างคือการกำหนด n ที่เล็กที่สุดแต่ยังตอบโจทย์ความแม่นยำที่ต้องการ
      </p>
    </section>

    <section class="card">
      <h2>2. ตัวแปรที่ต้องกำหนดล่วงหน้า</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>Margin of Error (E)</strong>
          <p>ความคลาดเคลื่อนสูงสุดที่ยอมรับได้ เช่น &plusmn;500 บาท หรือ &plusmn;3%</p>
        </div>
        <div class="highlight-box">
          <strong>ระดับความเชื่อมั่น</strong>
          <p>ใช้กำหนด Z<sub>&alpha/2</sub> เช่น 1.96 (95%) หรือ 2.576 (99%)</p>
        </div>
      </div>
      <p class="note">ต้องมีการประมาณการความกระจายของประชากร: &sigma; สำหรับค่าเฉลี่ย หรือ p สำหรับสัดส่วน</p>
    </section>

    <section class="card">
      <h2>3. สูตรคำนวณ</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>ค่าเฉลี่ย (&mu;)</strong>
          <p>n = ((Z<sub>&alpha/2</sub> &times; &sigma;) / E)²</p>
        </div>
        <div class="highlight-box">
          <strong>สัดส่วน (p)</strong>
          <p>n = p(1 − p) × (Z<sub>&alpha/2</sub> / E)²</p>
          <p class="note">ถ้าไม่รู้ p ให้ใช้ 0.5 เพื่อให้ได้ขนาดตัวอย่างสูงสุด (ปลอดภัยที่สุด)</p>
        </div>
      </div>
      <div class="callout"><strong>จำไว้:</strong> ผลลัพธ์ต้องปัดขึ้นเป็นจำนวนเต็มเสมอ ไม่มี “ครึ่งคน” ในตัวอย่าง</div>
    </section>

    <section class="card">
      <h2>4. ตัวอย่าง</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>รายได้เฉลี่ย</strong>
          <p>ต้องการ E = 500 บาท, &sigma; ≈ 4,000, ความเชื่อมั่น 95%<br />
            n = (1.96×4000/500)² = 245.86 &rarr; <strong>246 คน</strong>
          </p>
        </div>
        <div class="highlight-box">
          <strong>โพลความนิยม</strong>
          <p>E = 4%, ไม่รู้ p &rarr; ใช้ 0.5, ความเชื่อมั่น 99%<br />
            n = 0.5(0.5)×(2.576/0.04)² = 1036.84 &rarr; <strong>1,037 คน</strong>
          </p>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>ห้องทดลอง: ลองคำนวณขนาดตัวอย่าง</h2>
      <div class="playground">
        <form id="sample-size-form">
          <div class="control-group inline">
            <label>
              <span>เลือกประเภท</span>
              <select name="scenario">
                <option value="mean">ค่าเฉลี่ย (&mu;)</option>
                <option value="proportion">สัดส่วน (p)</option>
              </select>
            </label>
            <label>
              <span>ระดับความเชื่อมั่น</span>
              <select name="confidence">
                <option value="0.90">90%</option>
                <option value="0.95" selected>95%</option>
                <option value="0.99">99%</option>
              </select>
            </label>
            <label>
              <span>ระยะเผื่อความคลาดเคลื่อน (E)</span>
              <input type="number" name="margin" value="500" step="0.01" min="0.0001" />
            </label>
          </div>
          <div class="control-group inline" id="mean-inputs">
            <label>
              <span>ส่วนเบี่ยงเบนมาตรฐาน (&sigma;)</span>
              <input type="number" name="sigma" value="4000" step="0.01" min="0" />
            </label>
          </div>
          <div class="control-group inline" id="proportion-inputs" style="display:none;">
            <label>
              <span>ประมาณค่า p</span>
              <input type="number" name="p" value="0.5" step="0.01" min="0" max="1" />
            </label>
          </div>
        </form>
        <div class="result-board">
          <strong id="sample-size-summary">ขนาดตัวอย่างที่ต้องการ:</strong>
          <div class="stat-grid" id="sample-size-stats"></div>
          <p class="note" id="sample-size-note"></p>
        </div>
        <div class="canvas-wrap">
          <canvas id="sample-size-canvas" height="240"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script src="assets/lesson-tools.js"></script>
  <script>
    const {
      formatNumber,
      normInv,
      drawCurve,
      attachResizeRedraw
    } = window.LessonTools;

    const form = document.getElementById('sample-size-form');
    const meanInputs = document.getElementById('mean-inputs');
    const proportionInputs = document.getElementById('proportion-inputs');
    const summaryEl = document.getElementById('sample-size-summary');
    const statsEl = document.getElementById('sample-size-stats');
    const noteEl = document.getElementById('sample-size-note');
    const canvas = document.getElementById('sample-size-canvas');

    function computeSampleSize() {
      const scenario = form.elements['scenario'].value;
      const confidence = parseFloat(form.elements['confidence'].value) || 0.95;
      const margin = Math.max(0.0001, parseFloat(form.elements['margin'].value));
      const z = normInv(1 - (1 - confidence) / 2);
      let rawN = NaN;
      let descriptor = '';

      if (scenario === 'mean') {
        const sigma = Math.max(0, parseFloat(form.elements['sigma'].value));
        rawN = Math.pow((z * sigma) / margin, 2);
        descriptor = `ใช้ &sigma; = ${formatNumber(sigma)} ในการคำนวณ`;
        meanInputs.style.display = 'grid';
        proportionInputs.style.display = 'none';
      } else {
        let p = parseFloat(form.elements['p'].value);
        if (!Number.isFinite(p)) p = 0.5;
        p = Math.min(1, Math.max(0, p));
        rawN = p * (1 - p) * Math.pow(z / margin, 2);
        descriptor = p === 0.5 ? 'ใช้ p = 0.5 (กรณีปลอดภัยที่สุด)' : `ใช้ p ≈ ${formatNumber(p, 3)}`;
        meanInputs.style.display = 'none';
        proportionInputs.style.display = 'grid';
      }

      const nRounded = Math.ceil(rawN);
      summaryEl.textContent = `ขนาดตัวอย่างที่ต้องการ: ${formatNumber(nRounded, 0)} คน/หน่วย`; 

      statsEl.innerHTML = '';
      const stats = [
        { label: 'n (ไม่ปัดเศษ)', value: formatNumber(rawN, 2) },
        { label: 'Z-critical', value: formatNumber(z, 3) },
        { label: 'Margin (E)', value: formatNumber(margin, 3) }
      ];
      stats.forEach(stat => {
        const div = document.createElement('div');
        div.className = 'stat';
        div.innerHTML = `<span class="label">${stat.label}</span><span class="value">${stat.value}</span>`;
        statsEl.appendChild(div);
      });

      noteEl.textContent = descriptor + ' • ปัดขึ้นเสมอเพื่อความปลอดภัย';

      const points = [];
      const minN = Math.max(10, Math.floor(nRounded / 2));
      const maxN = Math.max(minN + 10, Math.ceil(nRounded * 1.6));
      for (let n = minN; n <= maxN; n += Math.max(1, Math.floor((maxN - minN) / 40))) {
        let currentMargin;
        if (scenario === 'mean') {
          const sigma = Math.max(0, parseFloat(form.elements['sigma'].value));
          currentMargin = z * sigma / Math.sqrt(n);
        } else {
          let p = parseFloat(form.elements['p'].value);
          if (!Number.isFinite(p)) p = 0.5;
          p = Math.min(1, Math.max(0.0001, p));
          currentMargin = z * Math.sqrt(p * (1 - p) / n);
        }
        points.push([n, currentMargin]);
      }
      drawCurve(canvas, points, { color: 'rgba(120,193,255,0.9)' });
    }

    form.addEventListener('input', computeSampleSize);
    form.addEventListener('change', computeSampleSize);
    computeSampleSize();
    attachResizeRedraw(canvas, computeSampleSize);
  </script>
</body>
</html>
