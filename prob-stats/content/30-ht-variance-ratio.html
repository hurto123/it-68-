<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>บทที่ 30 • การทดสอบอัตราส่วนความแปรปรวน</title>
  <meta name="description" content="ใช้การแจกแจง F เพื่อตรวจสอบว่าความแปรปรวนของสองกระบวนการแตกต่างกันหรือไม่ พร้อมเครื่องมือคำนวณแบบโต้ตอบ" />
  <link rel="stylesheet" href="assets/lesson-theme.css" />
</head>
<body>
  <main class="page">
    <header class="hero">
      <span class="badge">บทเรียนที่ 30</span>
      <h1>การทดสอบสมมติฐานอัตราส่วนความแปรปรวน (σ₁² / σ₂²)</h1>
      <p class="lead">
        เมื่อต้องการเปรียบเทียบความสม่ำเสมอของสองเครื่องจักรหรือสองผลิตภัณฑ์ เราใช้อัตราส่วนของความแปรปรวนและตัดสินด้วยการแจกแจง F
      </p>
      <div class="stat-grid">
        <div class="stat"><span class="label">สถิติทดสอบ</span><span class="value">F = s₁² / s₂²</span></div>
        <div class="stat"><span class="label">องศาอิสระ</span><span class="value">df₁ = n₁ − 1, df₂ = n₂ − 1</span></div>
        <div class="stat"><span class="label">การใช้งาน</span><span class="value">ANOVA, QC</span></div>
      </div>
    </header>

    <section class="card">
      <h2>1. ตั้งสมมติฐานให้ชัด</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>สมมติฐานมาตรฐาน</strong>
          <ul>
            <li>H<sub>0</sub>: σ₁² = σ₂² หรือ σ₁² / σ₂² = 1</li>
            <li>H<sub>1</sub>: เลือก &gt;, &lt; หรือ ≠ ตามคำถาม</li>
            <li>ข้อตกลง: ข้อมูลแต่ละกลุ่มมาจากการแจกแจงปกติ และกลุ่มเป็นอิสระต่อกัน</li>
          </ul>
        </div>
        <div class="highlight-box">
          <strong>การเลือกกลุ่ม</strong>
          <p>โดยทั่วไปเรียงกลุ่มให้สอดคล้องกับ H<sub>1</sub>:</p>
          <ul>
            <li>หางขวา: σ₁² &gt; σ₂² ⇒ วางกลุ่มที่สงสัยว่ามีความแปรปรวนสูงไว้ด้านบน</li>
            <li>หางซ้าย: σ₁² &lt; σ₂² ⇒ วางกลุ่มที่คาดว่ามีความแปรปรวนต่ำไว้ด้านบน</li>
            <li>สองหาง: ใช้อัตราส่วนตามข้อมูลจริง แล้วใช้เทคนิคสองหาง</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2. สูตรและการตีความ</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>ค่าสถิติทดสอบ</strong>
          <p>
            \[
              F_{\text{test}} = \frac{s_1^2}{s_2^2}
            \]
          </p>
          <p class="muted">ถ้า F &gt; 1 แสดงว่ากลุ่ม 1 กระจายตัวมากกว่า แต่การตัดสินต้องพิจารณาองศาอิสระ df₁, df₂ ด้วย</p>
        </div>
        <div class="highlight-box">
          <strong>ขอบเขตวิกฤต</strong>
          <ul>
            <li>หางขวา: เปรียบเทียบกับ F<sub>1−α, df₁, df₂</sub></li>
            <li>หางซ้าย: เปรียบเทียบกับ F<sub>α, df₁, df₂</sub> หรือใช้อัตราส่วนกลับ</li>
            <li>สองหาง: ใช้คู่ค่า F<sub>α/2</sub> และ F<sub>1−α/2</sub> (ด้านล่างคือ 1/F ของอีกฝั่งเมื่อสลับ df)</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3. กระบวนการพิจารณา</h2>
      <ol>
        <li>ตรวจสอบเงื่อนไขปกติ (Normality) ของแต่ละกลุ่ม หรือใช้การแปลงข้อมูล/วิธีไม่อิงพารามิเตอร์หากจำเป็น</li>
        <li>คำนวณ F<sub>test</sub> และ p-value พร้อมระบุองศาอิสระ</li>
        <li>สรุปผลเป็นภาษาคน: “กลุ่ม A มีความแปรปรวนสูงกว่ากลุ่ม B อย่างมีนัยสำคัญ” หรือ “ยังไม่เห็นความแตกต่าง”</li>
      </ol>
    </section>

    <section class="card">
      <h2>4. Interactive Playground</h2>
      <p>เปลี่ยนค่าตัวอย่างและเลือกทิศทางเพื่อดูผลลัพธ์ที่อัปเดตแบบเรียลไทม์</p>
      <div class="playground">
        <form id="f-form">
          <div class="grid two">
            <div class="control-group">
              <label>
                ขนาดตัวอย่างกลุ่ม 1 (n₁)
                <input type="number" name="n1" min="2" step="1" value="12" />
              </label>
              <label>
                ส่วนเบี่ยงเบนมาตรฐานกลุ่ม 1 (s₁)
                <input type="number" name="sd1" min="0" step="0.001" value="5" />
              </label>
            </div>
            <div class="control-group">
              <label>
                ขนาดตัวอย่างกลุ่ม 2 (n₂)
                <input type="number" name="n2" min="2" step="1" value="10" />
              </label>
              <label>
                ส่วนเบี่ยงเบนมาตรฐานกลุ่ม 2 (s₂)
                <input type="number" name="sd2" min="0" step="0.001" value="3.8" />
              </label>
            </div>
          </div>
          <div class="grid two">
            <label class="control-group">
              <span>ทิศทางสมมติฐาน</span>
              <select name="tail">
                <option value="right">หางขวา (σ₁² &gt; σ₂²)</option>
                <option value="left">หางซ้าย (σ₁² &lt; σ₂²)</option>
                <option value="two">สองหาง (σ₁² ≠ σ₂²)</option>
              </select>
            </label>
            <label class="control-group">
              <span>ระดับนัยสำคัญ (α)</span>
              <input type="number" name="alpha" min="0.0001" max="0.5" step="0.005" value="0.05" />
            </label>
          </div>
          <button type="submit">คำนวณผล</button>
        </form>
        <div class="result-board" id="f-result">
          <strong>ผลการทดสอบ</strong>
          <p>กรอกข้อมูลเพื่อดูสรุป</p>
        </div>
        <canvas id="f-plot" width="640" height="260" aria-hidden="true"></canvas>
      </div>
    </section>

    <section class="card">
      <h2>5. ตัวอย่าง: นักแม่นปืน A vs B</h2>
      <div class="grid two">
        <div class="highlight-box">
          <strong>ข้อมูล</strong>
          <ul>
            <li>กลุ่ม A: n₁ = 10, s₁² = 25</li>
            <li>กลุ่ม B: n₂ = 12, s₂² = 15</li>
            <li>ต้องการรู้ว่าความแปรปรวนต่างกันหรือไม่ ⇒ สองหาง</li>
          </ul>
        </div>
        <div class="highlight-box">
          <strong>ผลลัพธ์</strong>
          <ul>
            <li>F<sub>test</sub> = 25 / 15 ≈ 1.67</li>
            <li>df₁ = 9, df₂ = 11 ⇒ F<sub>0.95</sub> ≈ 2.90</li>
            <li>p-value ≈ 0.21 ⇒ ยังปฏิเสธ H<sub>0</sub> ไม่ได้</li>
          </ul>
          <p class="muted">สรุป: ยังไม่มีหลักฐานว่าความแม่นยำต่างกัน (ความแปรปรวนเทียบเท่ากันในระดับ 10%)</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>6. ข้อควรระวัง</h2>
      <ul>
        <li>การออกแบบการทดลองที่สมดุล (n ใกล้เคียงกัน) ทำให้การทดสอบมีพลังมากขึ้น</li>
        <li>ถ้าข้อมูลไม่ปกติ ให้พิจารณา Levene’s test หรือ Brown–Forsythe test แทน</li>
        <li>รายงานทั้งอัตราส่วนและผลต่างของส่วนเบี่ยงเบนมาตรฐานเพื่อช่วยตีความ</li>
      </ul>
    </section>
  </main>

  <script src="assets/lesson-tools.js"></script>
  <script>
    const { formatNumber, drawCurve, attachResizeRedraw } = window.LessonTools;
    const form = document.getElementById('f-form');
    const resultBoard = document.getElementById('f-result');
    const plot = document.getElementById('f-plot');

    function logGamma(z) {
      const coeffs = [
        676.5203681218851,
        -1259.1392167224028,
        771.32342877765313,
        -176.61502916214059,
        12.507343278686905,
        -0.13857109526572012,
        9.9843695780195716e-6,
        1.5056327351493116e-7
      ];
      if (z < 0.5) {
        return Math.log(Math.PI) - Math.log(Math.sin(Math.PI * z)) - logGamma(1 - z);
      }
      z -= 1;
      let x = 0.99999999999980993;
      for (let i = 0; i < coeffs.length; i++) {
        x += coeffs[i] / (z + i + 1);
      }
      const t = z + coeffs.length - 0.5;
      return 0.5 * Math.log(2 * Math.PI) + (z + 0.5) * Math.log(t) - t + Math.log(x);
    }

    function betaFunc(a, b) {
      return Math.exp(logGamma(a) + logGamma(b) - logGamma(a + b));
    }

    function fPdf(x, df1, df2) {
      if (x <= 0 || !(df1 > 0) || !(df2 > 0)) return 0;
      const a = df1 / 2;
      const b = df2 / 2;
      const logNumerator = a * Math.log(df1 / df2) + (a - 1) * Math.log(x);
      const logDenominator = Math.log(betaFunc(a, b)) + (a + b) * Math.log(1 + (df1 / df2) * x);
      return Math.exp(logNumerator - logDenominator);
    }

    function fCdf(x, df1, df2) {
      if (x <= 0) return 0;
      const steps = Math.max(400, Math.min(2400, Math.round(x * 160)));
      const h = x / steps;
      let sum = fPdf(0, df1, df2) + fPdf(x, df1, df2);
      for (let i = 1; i < steps; i++) {
        const weight = i % 2 === 0 ? 2 : 4;
        sum += weight * fPdf(i * h, df1, df2);
      }
      return (h / 3) * sum;
    }

    function fQuantile(p, df1, df2) {
      let low = 0;
      let high = 1;
      for (let i = 0; i < 80 && fCdf(high, df1, df2) < p; i++) {
        high *= 2;
        if (high > 1e6) break;
      }
      for (let i = 0; i < 60; i++) {
        const mid = (low + high) / 2;
        const cmid = fCdf(mid, df1, df2);
        if (!Number.isFinite(cmid)) break;
        if (cmid < p) low = mid;
        else high = mid;
      }
      return (low + high) / 2;
    }

    function updateFTest(event) {
      if (event) event.preventDefault();
      const data = new FormData(form);
      const n1 = Math.max(2, Number(data.get('n1')) || 2);
      const n2 = Math.max(2, Number(data.get('n2')) || 2);
      const sd1 = Math.max(0, Number(data.get('sd1')) || 0);
      const sd2 = Math.max(0, Number(data.get('sd2')) || 0);
      const tail = data.get('tail');
      const alpha = Math.min(0.5, Math.max(0.0001, Number(data.get('alpha')) || 0.05));

      if (!(sd1 > 0) || !(sd2 > 0)) {
        resultBoard.innerHTML = `
          <strong>ต้องการส่วนเบี่ยงเบนมาตรฐานที่มากกว่า 0</strong>
          <p>กรอกค่า s₁ และ s₂ ใหม่เพื่อคำนวณ</p>
        `;
        return;
      }

      const df1 = n1 - 1;
      const df2 = n2 - 1;
      const fTest = (sd1 * sd1) / (sd2 * sd2);
      const cdf = fCdf(fTest, df1, df2);
      const rightTail = Math.max(0, 1 - cdf);
      const leftTail = Math.max(0, cdf);
      let pValue;
      let decision;
      let criticalText = '';

      if (tail === 'right') {
        pValue = rightTail;
        const critical = fQuantile(1 - alpha, df1, df2);
        decision = pValue <= alpha ? 'ปฏิเสธ H₀ (σ₁² สูงกว่า)' : 'ยังปฏิเสธ H₀ ไม่ได้';
        criticalText = `F<sub>${formatNumber(1 - alpha, 3)}</sub> = ${formatNumber(critical, 3)}`;
      } else if (tail === 'left') {
        pValue = leftTail;
        const critical = fQuantile(alpha, df1, df2);
        decision = pValue <= alpha ? 'ปฏิเสธ H₀ (σ₁² ต่ำกว่า)' : 'ยังปฏิเสธ H₀ ไม่ได้';
        criticalText = `F<sub>${formatNumber(alpha, 3)}</sub> = ${formatNumber(critical, 3)}`;
      } else {
        const tailArea = fTest >= 1 ? rightTail : leftTail;
        pValue = Math.min(1, 2 * tailArea);
        const upperCritical = fQuantile(1 - alpha / 2, df1, df2);
        const swappedCritical = fQuantile(1 - alpha / 2, df2, df1);
        const lowerCritical = swappedCritical > 0 ? 1 / swappedCritical : 0;
        decision = pValue <= alpha ? 'ปฏิเสธ H₀ (ความแปรปรวนต่างกัน)' : 'ยังปฏิเสธ H₀ ไม่ได้';
        criticalText = `F<sub>${formatNumber(alpha / 2, 3)}</sub> = ${formatNumber(lowerCritical, 3)}, F<sub>${formatNumber(1 - alpha / 2, 3)}</sub> = ${formatNumber(upperCritical, 3)}`;
      }

      resultBoard.innerHTML = `
        <strong>${decision}</strong>
        <ul>
          <li>F<sub>test</sub> = ${formatNumber(fTest, 3)} (df₁ = ${df1}, df₂ = ${df2})</li>
          <li>p-value = ${formatNumber(pValue, 4)}</li>
          <li>${criticalText}</li>
          <li>อัตราส่วนส่วนเบี่ยงเบนมาตรฐาน = ${formatNumber(sd1 / sd2, 3)}</li>
        </ul>
        <p class="muted">เปรียบเทียบกับผลต่างที่แท้จริงเพื่อประเมินผลกระทบต่อคุณภาพงาน</p>
      `;

      const maxX = Math.max(fTest * 1.3, fQuantile(0.995, df1, df2) || fTest * 2 || 5);
      const points = [];
      const steps = 240;
      for (let i = 0; i <= steps; i++) {
        const x = (i / steps) * maxX;
        points.push([x, fPdf(Math.max(1e-6, x), df1, df2)]);
      }
      drawCurve(plot, points, { color: 'rgba(120, 193, 255, 0.9)' });
    }

    attachResizeRedraw(plot, () => updateFTest());
    form.addEventListener('submit', updateFTest);
    updateFTest();
  </script>
</body>
</html>
