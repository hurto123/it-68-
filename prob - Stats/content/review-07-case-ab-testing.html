<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>‡∏ö‡∏ó‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7: ‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤ #2 - A/B Testing</title>
<link href="../styles/tokens.css" rel="stylesheet"/>
<link href="../styles/components.css" rel="stylesheet"/>

<link href="../styles/typography-access.css" rel="stylesheet"/>
<link href="../styles/print.css" media="print" rel="stylesheet"/>
<script defer="" src="../app.js"></script>
<script defer="" src="../i18n/i18n.js"></script>
<style>
    .lesson {
      display: grid;
      gap: var(--size-6);
      padding: var(--size-6);
    }
    .lesson .card {
      padding: var(--size-5);
    }
    .scenario {
      background: var(--surface-subtle);
      border-left: 4px solid var(--accent-strong);
      border-radius: var(--radius-md);
      padding: var(--size-4);
    }
    .lab {
      display: grid;
      gap: var(--size-4);
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      align-items: start;
    }
    .lab label {
      display: flex;
      flex-direction: column;
      gap: var(--size-2);
      font-weight: 600;
    }
    .lab input,
    .lab button {
      padding: var(--size-2);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-muted);
      font: inherit;
    }
    .lab button {
      cursor: pointer;
      background: var(--accent-muted);
      color: var(--accent-strong);
      border: none;
      font-weight: 600;
    }
    .lab canvas {
      width: 100%;
      height: 240px;
      border-radius: var(--radius-md);
      background: var(--surface-muted);
    }
    .results {
      background: var(--surface-subtle);
      border-radius: var(--radius-md);
      padding: var(--size-3);
      display: grid;
      gap: var(--size-2);
    }
    @media print {
      .lesson {
        padding: 0;
      }
    }
  </style>
<link href="../styles/light.css" id="theme-link" rel="stylesheet"/><link href="../hotfix.css" rel="stylesheet"/><link href="../styles/skin-clean.css" rel="stylesheet"/></head>
<body class="skin-clean" data-page="review"><a class="skip-link" href="#main">‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</a>
<header class="site-header">
<div>
<p class="eyebrow">üë®‚Äçüè´ ‡∏ö‡∏ó‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ó‡∏µ‡πà 7</p>
<h1>‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤ #2 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° (A/B Testing)</h1>
<p class="subtitle">‡∏ù‡∏∂‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏™‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°</p>
</div>
<nav class="header-actions">
<a class="ghost" href="../index.html#review">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ</a>
<button class="ghost" id="print-current">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
</nav>
</header>
<main class="lesson" id="main">
<nav aria-label="‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ" class="toc sticky" id="auto-toc">
<!-- will be populated by app.js -->
</nav><article class="card flow">
<div class="scenario">
<h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏°‡∏°‡∏ï‡∏¥</h2>
<p>‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå E-commerce ‡∏ó‡∏µ‡∏°‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢" 2 ‡πÅ‡∏ö‡∏ö ‡∏Ñ‡∏∑‡∏≠ ‡πÅ‡∏ö‡∏ö A (‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ö‡∏ö B (‡∏™‡∏µ‡∏™‡πâ‡∏°) ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÑ‡∏´‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏±‡∏ô</p>
<ul>
<li>‡∏Å‡∏•‡∏∏‡πà‡∏° A: n<sub>A</sub> = 1,500, ‡∏Ñ‡∏•‡∏¥‡∏Å x<sub>A</sub> = 120 ‚Üí \(\hat{p}_A = 0.08\)</li>
<li>‡∏Å‡∏•‡∏∏‡πà‡∏° B: n<sub>B</sub> = 1,500, ‡∏Ñ‡∏•‡∏¥‡∏Å x<sub>B</sub> = 150 ‚Üí \(\hat{p}_B = 0.10\)</li>
</ul>
</div>
</article>
<article class="card flow">
<h2>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö (‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á)</h2>
<ol>
<li>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: \(\hat{p}_A = 0.08\), \(\hat{p}_B = 0.10\)</li>
<li>‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏∏‡∏î: \(\hat{p}_B - \hat{p}_A = 0.02\)</li>
<li>‡πÉ‡∏ä‡πâ Z-Interval ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°</li>
<li>‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô 95%: 0.02 ¬± 0.0204 ‚Üí (-0.0004, 0.0404)</li>
</ol>
<p><em>‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°:</em> ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏£‡πà‡∏≠‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå ‚Üí ‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏ô‡∏ò‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏î‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
</article>
<article class="card flow">
<h2>‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡∏≤ (‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á)</h2>
<ol>
<li>‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô: H<sub>0</sub>: p<sub>A</sub> = p<sub>B</sub>, H<sub>1</sub>: p<sub>A</sub> ‚â† p<sub>B</sub></li>
<li>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç Œ± = 0.05</li>
<li>‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥: Z<sub>test</sub> = 1.92</li>
<li>p-value (‡∏™‡∏≠‡∏á‡∏´‡∏≤‡∏á) = 0.0548</li>
<li>‡∏™‡∏£‡∏∏‡∏õ: p-value &gt; Œ± ‚Üí ‡∏¢‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò H<sub>0</sub> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</li>
</ol>
<p><em>‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°:</em> ‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏±‡∏á‡πÄ‡∏≠‡∏¥‡∏ç ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏û‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤</p>
</article>
<article class="card flow">
<h2>A/B Testing Lab</h2>
<p>‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)</p>
<div class="lab">
<div class="control flow">
<label for="a-n">n<sub>A</sub>
<input id="a-n" min="1" type="number" value="1500"/>
</label>
<label for="a-x">x<sub>A</sub>
<input id="a-x" min="0" type="number" value="120"/>
</label>
<label for="b-n">n<sub>B</sub>
<input id="b-n" min="1" type="number" value="1500"/>
</label>
<label for="b-x">x<sub>B</sub>
<input id="b-x" min="0" type="number" value="150"/>
</label>
<label for="alpha">Œ±
            <input id="alpha" max="0.2" min="0.001" step="0.001" type="number" value="0.05"/>
</label>
<div aria-live="polite" class="results">
<p><strong>\(\hat{p}_A\):</strong> <span id="p-a">0.00</span></p>
<p><strong>\(\hat{p}_B\):</strong> <span id="p-b">0.00</span></p>
<p><strong>CI 95%:</strong> <span id="ci">[0, 0]</span></p>
<p><strong>Z<sub>test</sub>:</strong> <span id="z-test">0.00</span></p>
<p><strong>p-value (‡∏™‡∏≠‡∏á‡∏´‡∏≤‡∏á):</strong> <span id="p-value">0.000</span></p>
<p><strong>‡∏Ñ‡∏≥‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô:</strong> <span id="verdict">‡∏¢‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò H<sub>0</sub> ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</span></p>
</div>
</div>
<canvas aria-label="‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡∏Å‡∏§‡∏ï" id="ab-chart" role="img"></canvas>
</div>
</article>
</main>
<footer class="site-footer">
<p>¬© 2024 Stats Learning Lab</p>
<a class="ghost" href="../index.html">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
</footer>
<script>
    const abCanvas = document.getElementById('ab-chart');
    const abCtx = abCanvas.getContext('2d');
    const aNInput = document.getElementById('a-n');
    const aXInput = document.getElementById('a-x');
    const bNInput = document.getElementById('b-n');
    const bXInput = document.getElementById('b-x');
    const alphaInput = document.getElementById('alpha');
    const pALabel = document.getElementById('p-a');
    const pBLabel = document.getElementById('p-b');
    const ciLabel = document.getElementById('ci');
    const zLabel = document.getElementById('z-test');
    const pValueLabel = document.getElementById('p-value');
    const verdictLabel = document.getElementById('verdict');

    function resizeAbCanvas() {
      const ratio = window.devicePixelRatio || 1;
      const width = abCanvas.clientWidth;
      const height = abCanvas.clientHeight;
      abCanvas.width = width * ratio;
      abCanvas.height = height * ratio;
      abCtx.setTransform(1, 0, 0, 1, 0, 0);
      abCtx.scale(ratio, ratio);
    }

    function updateAB() {
      const nA = Math.max(1, Number(aNInput.value));
      const xA = Math.min(nA, Math.max(0, Number(aXInput.value)));
      const nB = Math.max(1, Number(bNInput.value));
      const xB = Math.min(nB, Math.max(0, Number(bXInput.value)));
      const alpha = Number(alphaInput.value);

      const pA = xA / nA;
      const pB = xB / nB;
      const diff = pB - pA;
      const se = Math.sqrt((pB * (1 - pB)) / nB + (pA * (1 - pA)) / nA);
      const zCritical = inverseNormalCDF(1 - 0.05 / 2);
      const margin = zCritical * se;
      const ciLower = diff - margin;
      const ciUpper = diff + margin;

      const pooled = (xA + xB) / (nA + nB);
      const zTest = (diff) / Math.sqrt(pooled * (1 - pooled) * (1 / nA + 1 / nB));
      const pValue = 2 * (1 - cumulativeNormal(Math.abs(zTest)));
      const reject = pValue <= alpha;

      pALabel.textContent = pA.toFixed(4);
      pBLabel.textContent = pB.toFixed(4);
      ciLabel.textContent = `[${ciLower.toFixed(4)}, ${ciUpper.toFixed(4)}]`;
      zLabel.textContent = zTest.toFixed(3);
      pValueLabel.textContent = pValue.toFixed(4);
      verdictLabel.textContent = reject ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò H‚ÇÄ' : '‡∏¢‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò H‚ÇÄ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
      verdictLabel.style.color = reject ? 'var(--critical-strong, #c1121f)' : 'var(--text-strong, #111)';

      drawDistribution(diff, se, alpha, zTest);
    }

    function drawDistribution(diff, se, alpha, zTest) {
      const width = abCanvas.clientWidth;
      const height = abCanvas.clientHeight;
      const ratio = window.devicePixelRatio || 1;
      abCtx.setTransform(ratio, 0, 0, ratio, 0, 0);
      abCtx.clearRect(0, 0, abCanvas.width, abCanvas.height);

      const padding = 36;
      const start = -0.15;
      const end = 0.15;
      const steps = 200;
      const xScale = (width - padding * 2) / (end - start);
      const yScale = (height - padding * 2) / 12;

      abCtx.strokeStyle = 'var(--border-muted, #c7d0ff)';
      abCtx.beginPath();
      abCtx.moveTo(padding, height - padding);
      abCtx.lineTo(width - padding / 2, height - padding);
      abCtx.stroke();

      abCtx.beginPath();
      for (let i = 0; i <= steps; i += 1) {
        const x = start + (i / steps) * (end - start);
        const z = (x - diff) / se;
        const y = normalPdf(z);
        const canvasX = padding + (x - start) * xScale;
        const canvasY = height - padding - y * yScale;
        if (i === 0) {
          abCtx.moveTo(canvasX, canvasY);
        } else {
          abCtx.lineTo(canvasX, canvasY);
        }
      }
      abCtx.strokeStyle = 'var(--accent-strong, #4a63e7)';
      abCtx.lineWidth = 2;
      abCtx.stroke();

      const crit = inverseNormalCDF(1 - alpha / 2);
      const lowerCrit = diff - crit * se;
      const upperCrit = diff + crit * se;
      const lowerX = padding + (lowerCrit - start) * xScale;
      const upperX = padding + (upperCrit - start) * xScale;
      abCtx.fillStyle = 'var(--critical-strong, #c1121f)';
      abCtx.fillRect(lowerX - 2, height - padding - 140, 4, 120);
      abCtx.fillRect(upperX - 2, height - padding - 140, 4, 120);
      abCtx.fillText(`critical = ¬±${(crit * se).toFixed(3)}`, padding + 12, padding + 16);

      const statX = padding + (0 - start) * xScale;
      abCtx.fillStyle = 'var(--text-strong, #111)';
      abCtx.fillRect(statX - 2, height - padding - 160, 4, 160);
      abCtx.fillText('‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á = 0 (H‚ÇÄ)', statX - 40, padding + 32);

      const diffX = padding + (diff - start) * xScale;
      abCtx.fillStyle = 'var(--accent-strong, #4a63e7)';
      abCtx.fillRect(diffX - 2, height - padding - 160, 4, 160);
      abCtx.fillText(`diff = ${diff.toFixed(3)}`, diffX - 30, padding + 48);
    }

    function cumulativeNormal(x) {
      return 0.5 * (1 + erf(x / Math.sqrt(2)));
    }

    function normalPdf(x) {
      return (1 / Math.sqrt(2 * Math.PI)) * Math.exp(-0.5 * x * x);
    }

    function erf(x) {
      const sign = x >= 0 ? 1 : -1;
      const a1 = 0.254829592;
      const a2 = -0.284496736;
      const a3 = 1.421413741;
      const a4 = -1.453152027;
      const a5 = 1.061405429;
      const p = 0.3275911;
      const absX = Math.abs(x);
      const t = 1 / (1 + p * absX);
      const y = 1 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-absX * absX);
      return sign * y;
    }

    function inverseNormalCDF(p) {
      return Math.sqrt(2) * invErf(2 * p - 1);
    }

    function invErf(x) {
      const a = 0.147;
      const ln = Math.log(1 - x * x);
      const term1 = 2 / (Math.PI * a) + ln / 2;
      const term2 = ln / a;
      return Math.sign(x) * Math.sqrt(Math.sqrt(term1 * term1 - term2) - term1);
    }

    [aNInput, aXInput, bNInput, bXInput, alphaInput].forEach((el) => el.addEventListener('input', updateAB));

    resizeAbCanvas();
    window.addEventListener('resize', () => {
      resizeAbCanvas();
      updateAB();
    });

    updateAB();
  </script>
<!-- Fallback systems for content pages -->
<script>
  (function(){
    // Theme toggle & Print
    const themeLink = document.getElementById('theme-link');
    const themeBtn = document.getElementById('theme-toggle');
    const printBtn = document.getElementById('print-current');
    function toggleTheme(){
      if(!themeLink) return;
      const href = themeLink.getAttribute('href');
      if(href.includes('light.css')){
        themeLink.setAttribute('href', href.replace('light.css','theme-high-contrast.css'));
        localStorage.setItem('stats-theme','hc');
      }else if(href.includes('theme-high-contrast.css')){
        themeLink.setAttribute('href', href.replace('theme-high-contrast.css','light.css'));
        localStorage.setItem('stats-theme','light');
      }
    }
    try{
      const pref = localStorage.getItem('stats-theme');
      if(themeLink && pref==='hc' && themeLink.getAttribute('href').includes('light.css')){
        themeLink.setAttribute('href', themeLink.getAttribute('href').replace('light.css','theme-high-contrast.css'));
      }
    }catch(e){}
    themeBtn && themeBtn.addEventListener('click', toggleTheme);
    printBtn && printBtn.addEventListener('click', ()=>window.print());

    // Shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key==='t' || e.key==='T') toggleTheme();
      if(e.key==='p' || e.key==='P') window.print();
      if(e.key==='['){ const a=document.querySelector('.prev-next a.prev[href]'); if(a){ e.preventDefault(); location.href=a.getAttribute('href'); } }
      if(e.key===']'){ const a=document.querySelector('.prev-next a.next[href]'); if(a){ e.preventDefault(); location.href=a.getAttribute('href'); } }
    });

    // Progress bar
    (function(){
      const bar = document.querySelector('#progressbar>span');
      if(!bar) return;
      const onScroll = ()=>{
        const el = document.scrollingElement || document.documentElement;
        const max = el.scrollHeight - el.clientHeight;
        const pct = max>0 ? (el.scrollTop/max)*100 : 0;
        bar.style.width = pct.toFixed(2)+'%';
      };
      document.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    // Build TOC from h2/h3
    (function(){
      const toc = document.getElementById('auto-toc');
      if(!toc) return;
      const heads = Array.from(document.querySelectorAll('main h2, main h3'));
      toc.innerHTML = '';
      heads.forEach((h,i)=>{
        if(!h.id){
          h.id = (h.textContent||('sec-'+i)).trim().toLowerCase().replace(/[^a-z0-9‡∏Å-‡πô]+/g,'-');
        }
        const a = document.createElement('a');
        a.href = '#'+h.id;
        a.textContent = h.textContent;
        if(h.tagName.toLowerCase()==='h3'){ a.style.paddingLeft = '1rem'; }
        toc.appendChild(a);
      });
      const links = Array.from(toc.querySelectorAll('a'));
      const obs = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            links.forEach(l=>l.classList.toggle('active', l.getAttribute('href')==='#'+e.target.id));
          }
        });
      }, {rootMargin:'0px 0px -70% 0px', threshold:.1});
      heads.forEach(h=>obs.observe(h));
    })();

    // Visited tracking
    (function(){
      try{
        var key = 'stats-visited';
        var href = location.pathname.split('/').slice(-2).join('/'); // content/NN-xxx.html
        var set = new Set(JSON.parse(localStorage.getItem(key) || '[]'));
        set.add(href);
        localStorage.setItem(key, JSON.stringify(Array.from(set)));
        localStorage.setItem('stats-last-lesson', JSON.stringify({ href, title: document.title, ts: Date.now() }));
      }catch(e){}
    })();

  })();
  </script>
<script>
(function(){
  const link = document.getElementById('theme-link');
  if(link && link.getAttribute('href').includes('theme-high-contrast.css')){
    link.setAttribute('href', link.getAttribute('href').replace('theme-high-contrast.css','light.css'));
  }
  try{ if(localStorage.getItem('stats-theme')==='hc'){ localStorage.removeItem('stats-theme'); } }catch(e){}
})();
</script>
<script defer="True" src="../hotfix.js"></script></body>
</html>
